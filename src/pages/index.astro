---
import GameLayout from '../layouts/GameLayout.astro';
import { createInitialState } from '../lib/gameState.js';
import { encodeGameState } from '../lib/urlCodec.js';

export const prerender = false;

const MEAL_COUNT_OPTIONS = [3, 5, 7, 10];
const BUDGET_OPTIONS = [
  { value: 'tight', label: 'Tight', desc: 'Mostly budget meals' },
  { value: 'moderate', label: 'Moderate', desc: 'Mix of options' },
  { value: 'fancy', label: 'Fancy', desc: 'Splurge worthy' },
  { value: 'none', label: 'No Limit', desc: 'Sky\'s the limit' }
];
const ALLERGEN_OPTIONS = ['dairy', 'gluten', 'nuts', 'shellfish', 'soy', 'eggs'];
---

<GameLayout>
  <div class="panel">
    <div class="panel-title">DINNER QUEST</div>

    <form id="setup-form" class="setup-form">
      <div class="form-section">
        <label class="form-label">How many meals for the week?</label>
        <div class="option-grid">
          {MEAL_COUNT_OPTIONS.map(count => (
            <label class="option-card">
              <input type="radio" name="mealCount" value={count} checked={count === 5} />
              <span class="option-content">
                <span class="option-number">{count}</span>
                <span class="option-text">meals</span>
              </span>
            </label>
          ))}
        </div>
      </div>

      <div class="form-section">
        <label class="form-label">Budget for the week?</label>
        <div class="option-grid">
          {BUDGET_OPTIONS.map(budget => (
            <label class="option-card">
              <input type="radio" name="budgetCap" value={budget.value} checked={budget.value === 'moderate'} />
              <span class="option-content">
                <span class="option-title">{budget.label}</span>
                <span class="option-desc">{budget.desc}</span>
              </span>
            </label>
          ))}
        </div>
      </div>

      <div class="form-section">
        <label class="form-label">Any allergies or restrictions?</label>
        <div class="allergen-grid">
          {ALLERGEN_OPTIONS.map(allergen => (
            <label class="allergen-checkbox">
              <input type="checkbox" name="allergies" value={allergen} />
              <span>{allergen}</span>
            </label>
          ))}
        </div>
      </div>

      <button type="submit" class="btn btn-primary">
        Conjure the Feast
      </button>
    </form>
  </div>

  <div class="narrative" id="narrative">
    <p id="narrative-1"></p>
    <p id="narrative-2"></p>
    <p id="narrative-3"></p>
  </div>

  <script>
    // Theme content
    const themeContent = {
      'theme-fantasy': {
        narrative: [
          'The realm calls to you, brave adventurer.',
          'Two heroes. One legendary quest. A week of feasts to secure.',
          'Will your choices forge <span class="highlight">harmony</span>... or summon the dragons of discord?'
        ],
        buttonText: 'Begin the Quest'
      },
      'theme-cyberpunk': {
        narrative: [
          'Welcome to the Grid. Systems online.',
          'Two netrunners. One database. Seven days of sustenance protocols.',
          'Will you achieve <span class="highlight">sync</span>... or crash into takeout chaos?'
        ],
        buttonText: 'Initialize Protocol'
      },
      'theme-western': {
        narrative: [
          'The frontier stretches wide, partner.',
          'Two gunslingers. One saloon. A week of grub to wrangle.',
          'Will you ride together in <span class="highlight">harmony</span>... or face off at high noon?'
        ],
        buttonText: 'Draw Your Hand'
      },
      'theme-noir': {
        narrative: [
          'It was a dark and stormy night. The case file lay open.',
          'Two detectives. One mystery. Seven meals missing from the week.',
          'Will you crack the case with <span class="highlight">harmony</span>... or let it go cold?'
        ],
        buttonText: 'Open the Case'
      },
      'theme-pirate': {
        narrative: [
          'Ahoy there, ye scurvy dogs! The seas be callin\'.',
          'Two pirates. One ship. A week of plunder to claim.',
          'Will ye sail as mates in <span class="highlight">harmony</span>... or make each other walk the plank?'
        ],
        buttonText: 'Set Sail'
      },
      'theme-medieval': {
        narrative: [
          'Hear ye, hear ye! The royal court assembles.',
          'Two nobles. One banquet hall. A week of feasts to decree.',
          'Will thy choices bring <span class="highlight">harmony</span>... or spark a courtly dispute?'
        ],
        buttonText: 'Herald the Banquet'
      },
      'theme-space': {
        narrative: [
          'Mission Control to crew: systems are go.',
          'Two astronauts. One vessel. Seven days of rations to secure.',
          'Will your coordinates align in <span class="highlight">harmony</span>... or drift into the void?'
        ],
        buttonText: 'Launch Mission'
      },
      'theme-horror': {
        narrative: [
          'The old mansion groans. Something stirs in the shadows.',
          'Two souls. One haunted week. Seven cursed meals await.',
          'Will you survive together in <span class="highlight">harmony</span>... or become the next ghosts?'
        ],
        buttonText: 'Enter the Manor'
      }
    };

    // Apply random theme
    const themes = Object.keys(themeContent);
    const randomTheme = themes[Math.floor(Math.random() * themes.length)];
    document.body.className = randomTheme;

    // Apply themed content
    const content = themeContent[randomTheme];
    document.getElementById('narrative-1').innerHTML = content.narrative[0];
    document.getElementById('narrative-2').innerHTML = content.narrative[1];
    document.getElementById('narrative-3').innerHTML = content.narrative[2];
    document.querySelector('.btn-primary').textContent = content.buttonText;

    const form = document.getElementById('setup-form');

    form.addEventListener('submit', async (e) => {
      e.preventDefault();

      const formData = new FormData(form);
      const mealCount = parseInt(formData.get('mealCount'));
      const budgetCap = formData.get('budgetCap');
      const allergies = formData.getAll('allergies');

      // Navigate to waiting page with game settings
      const params = new URLSearchParams({
        mealCount: mealCount.toString(),
        budgetCap,
        allergies: allergies.join(',')
      });

      window.location.href = `/waiting?${params.toString()}`;
    });
  </script>

  <style>
    .setup-form {
      display: flex;
      flex-direction: column;
      gap: 30px;
    }

    .form-section {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .form-label {
      font-family: 'Press Start 2P', monospace;
      font-size: 12px;
      color: var(--primary);
    }

    .option-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
      gap: 10px;
    }

    .option-card {
      position: relative;
      cursor: pointer;
    }

    .option-card input[type="radio"] {
      position: absolute;
      opacity: 0;
    }

    .option-content {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 8px;
      padding: 16px;
      border: 2px solid var(--border);
      background: var(--bg-panel);
      transition: all 0.2s;
    }

    .option-card input[type="radio"]:checked + .option-content {
      border-color: var(--accent);
      border-width: 3px;
      background: var(--bg-dark);
      transform: translateY(-6px) scale(1.03);
      box-shadow: 0 6px 12px rgba(0, 0, 0, 0.12);
    }

    .option-card:hover .option-content {
      border-color: var(--primary-dim);
      transform: translateY(-2px);
    }

    .option-number {
      font-size: 24px;
      font-weight: bold;
      color: var(--primary);
    }

    .option-text {
      font-size: 12px;
      color: var(--text-dim);
    }

    .option-title {
      font-size: 12px;
      font-weight: bold;
      color: var(--text);
    }

    .option-desc {
      font-size: 12px;
      color: var(--text-dim);
      text-align: center;
    }

    .allergen-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
      gap: 8px;
    }

    .allergen-checkbox {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px;
      border: 2px solid var(--border);
      background: var(--bg-panel);
      cursor: pointer;
      font-size: 12px;
      transition: all 0.2s;
    }

    .allergen-checkbox input[type="checkbox"]:checked {
      accent-color: var(--accent);
    }

    .allergen-checkbox:has(input[type="checkbox"]:checked) {
      border-color: var(--accent);
      border-width: 3px;
      background: var(--bg-dark);
      transform: translateY(-4px) scale(1.02);
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }

    .allergen-checkbox:hover {
      border-color: var(--primary-dim);
      transform: translateY(-2px);
    }

    .btn-primary {
      margin-top: 20px;
      padding: 16px;
      font-size: 14px;
      background: var(--accent);
      color: var(--bg-dark);
      border: none;
      cursor: pointer;
      font-family: 'Press Start 2P', monospace;
      transition: all 0.2s;
    }

    .btn-primary:hover {
      background: var(--accent);
      opacity: 0.9;
      transform: translateY(-4px);
      box-shadow: 0 6px 12px var(--accent-glow);
    }

    .highlight {
      color: var(--primary);
      font-weight: bold;
    }
  </style>
</GameLayout>
